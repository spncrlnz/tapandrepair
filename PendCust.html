<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>T.A.R. Dashboard</title>

    <link rel="icon" href="images/icon_logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="sweetalert2.min.css" />
    <link rel="stylesheet" href="css/PendApp.css" />

    <script src="https://kit.fontawesome.com/6f40c2c1f0.js" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="sweetalert2.min.js"></script>
  </head>

  <body>
    <div class="wrapper">
      <!--SideBar Contents-->
      <aside id="sidebar">
        <!--Content for Sidebar-->
        <div class="h-100">
          <div class="sidebar-logo">
            <a href="#">
              <img src="images/icon_logo.png" style="width: auto; height: 60px; max-height: 120px" alt="Logo" />
              Tap and Repair
            </a>
            <ul class="sidebar-nav">
              <!--Pending-->
              <li class="sidebar-header">Pending</li>
              <li class="sidebar-item">
                <a href="PendCust.html" class="sidebar-link">
                  <i class="fa-solid fa-users"></i>
                  Customers
                </a>
              </li>
              <li class="sidebar-item">
                <a href="PendMech.html" class="sidebar-link">
                  <i class="fa-solid fa-wrench"></i>
                  Mechanics
                </a>
              </li>
              <li class="sidebar-item">
                <a href="PendSO.html" class="sidebar-link">
                  <i class="fa-solid fa-shop"></i>
                  Shop Owners
                </a>
              </li>

              <hr />

              <!--Approved-->
              <li class="sidebar-header">Approved</li>
              <li class="sidebar-item">
                <a href="ApprCust.html" class="sidebar-link">
                  <i class="fa-solid fa-users"></i>
                  Customers
                </a>
              </li>
              <li class="sidebar-item">
                <a href="ApprMech.html" class="sidebar-link">
                  <i class="fa-solid fa-wrench"></i>
                  Mechanics
                </a>
              </li>
              <li class="sidebar-item">
                <a href="ApprSO.html" class="sidebar-link">
                  <i class="fa-solid fa-shop"></i>
                  Shop Owners
                </a>
              </li>

              <hr />

              <!--Reports-->
              <li class="sidebar-link">
                <a href="Reports.html" class="sidebar-link">
                  <i class="fa-solid fa-file-pen"></i>
                  Reports
                </b>
              </li>

              <!--Log Out-->
              <li class="sidebar-link">
                <a href="#" onClick="signout()" class="sidebar-link">
                  <i class="fa-solid fa-right-from-bracket"></i>
                  Log-Out
                </a>
              </li>
            </ul>
          </div>
        </div>
      </aside>

      <!--Main Contents-->
      <div class="main">
        <nav class="navbar navbar-expand px-3 border-bottom">
          <button class="btn" id="sidebar-toggle" type="button">
            <span class="navbar-toggler-icon"></span>
          </button>
        </nav>
        <main class="content px-3 py-2">
          <div class="container-fluid">
            <div class="mb-3">
              <h4>Pending Customers</h4>
            </div>

            <!--Data Table-->
            <div class="card border-0">
              <div class="card-body">
                <table class="table">
                  <thead
                    class="table-dark table-bordered align-items-center mb-0" >
                    <tr
                      class="text-uppercase text-nonwrap text-xxs font-weight-bolder ps-2" >
                      <th>Full Name</th>
                      <th>E-Mail</th>
                      <th>Number</th>
                      <th>E-Mail Status</th>
                      <th>Document</th>
                      <th>Reject</th>
                      <th>Approve</th>
                    </tr>
                  </thead>
                  <tbody class="table-cotent"></tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!--Opening Document/ID-->
    <div class="modal fade" id="modalDocument" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel"></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="docs"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!--Collapsible Button for Sidebar-->
    <script>
      const sidebarToggle = document.querySelector("#sidebar-toggle");
      sidebarToggle.addEventListener("click", function () {
        document.querySelector("#sidebar").classList.toggle("collapsed");
      });
    </script>

    <!--Separate JavaScript File Connection for Firebase-->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>

    <!--Sweet Alert JavaScript Link-->
    <script src="sweetalert2.min.js"></script>

    <!--Separate JavaScript File Connection for Firebase-->
    <script src="js/mainContent.js"></script>

    <script>
      var db = firebase.database();
      $(document).ready(function(){
        getData();
      });

      function getData(){
        dbref.ref("users").orderByChild("usertype").equalTo("Customer").on('value', function(snapshot){
          if (snapshot.exists()) {
            var content = '';
            $('#table-content').empty();
            snapshot.forEach(function (data){
              var val = data.val();
              if (val.verify == 0) {
                content += `<tr>`;
                  if (val.fullname) {
                    content += '<td class = "text-nonwrap">' + val.fullname + '</td>';
                  } else {
                    content += '<td> - </td>';
                  }

                  if (val.email) {
                    content += '<td class = "text-nonwrap">' + val.email + '</td>';
                  } else {
                    content += '<td> - </td>';
                  }
                  
                  if (val.contactnumber) {
                    content += '<td class = "text-nonwrap">' + val.contactnumber + '</td>';
                  } else {
                    content += '<td> - </td>';
                  }

                  if (val.verify == true) {
                    content += `
                    <td> 
                      <button class = "btn btn-primary btn-block" onclick = "openDocument('${val.uid}')"> View </button>
                    </td>
                    <td class = "text-center">
                      <span class = "badge rounded-pill text-bg-success"> Verified </span>
                    </td>
                    <td>
                     <button class = "btn btn-danger btn-block" onclick = "userStatusUpdate('${val.uid}', 'false')"> Reject </button>
                    </td>
                    <td>
                      <button class = "btn btn-success btn-block" onclick = "userStatusUpdate('${val.uid}', 'true')"> Aprrove </button>
                    </td>`;
                  } else if (val.verify == false) {
                    content += `
                    <td>
                      <button class = "btn btn-primary btn-block" onclick = "openDocument('${val.uid}')"> View </button>
                    </td>
                    <td class = "text-center">
                      <span class = "rounded-pill text-bg-danger"> Not Verified </span>
                    </td>
                    <td>
                      <button class = "btn btn-danger btn-block" onclick = "userStatusUpdate('${val.uid}', 'false')"> Reject </button>
                    </td>
                    <td>
                      <button class = "btn btn-danger btn-block" onclick = "userStatusUpdate('${val.uid}', 'false')"> Reject </button>
                    </td>`;
                  }
                  content += '</tr>';
              }
            })
            $('#table-content').append(content);
            $("#table-content").each(function (elem, index) {
              var arr = $.makeArray($("tr", this).detach());
              arr.reverse();
              $(this).append(arr);
            })
          }
          checkTable();
        })
      };

      function checkTable(){
        let table = document.getElementById("table-content");
        if (table.row.length == 0) {
          $('#table-content').empty();
          $('#table-content').append('<h6 class = "text-danger mt-5 text-nonwrap"> No Data Found </h6>');
        }
      }

      async function openDocument(uid){
        $("#docs").empty();
          Swal.fire({
            icon: 'info',
            title: 'Warning! The document you are about to view is Confidential. Make sure it is Secure and only used for System User Authentication.',
            showDenyButton: false,
            showCancelButton: true,
            confirmButtonText: 'Okay',
          }).then((result) => {
            if (result.isConfirmed) {
              db.ref("users").child(uid).once("value", function (s) {
                var val = s.val();
                var content = ``;

                if (val.usertype == "customer") {
                  content += `
                  <h4> Valid ID </h4>
                  <img src = "${val.profilePictureUrl}" alt = "" class = "img-fluid border" style = "width: 100%; max-height: auto;">`;
                } else {
                  content += `
                  <h4> Valid ID </h4>
                  <img src = "${val.profilePictureUrl}" alt = "" class = "img-fluid border" style = "width: 100%; max-height: auto;">`;
                }
              })
            }
            $("#docs").append(content);
            $("#modalDocument").modal("show");
          })
      }

    </script>
  </body>
</html>
